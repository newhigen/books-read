<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ page.title }}</title>
  <link rel="stylesheet" href="{{ '/src/style.css' | relative_url }}">
  <link rel="icon" href="{{ '/favicon.ico' | relative_url }}" type="image/x-icon">
  {% include google-analytics.html %}
  <script type="module">
    import { initTheme } from "{{ '/src/utils.js' | relative_url }}";
    document.addEventListener('DOMContentLoaded', () => {
      initTheme('theme-toggle');
      wrapThoughts();
      buildTableOfContents();
      wireTocShortcuts();
    });

    function wrapThoughts() {
      const root = document.querySelector('.review-content');
      if (!root) return;
      const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
      const targets = [];
      while (walker.nextNode()) {
        const node = walker.currentNode;
        if (node.nodeValue.includes('ã€Œ') && node.nodeValue.includes('ã€')) {
          targets.push(node);
        }
      }
      targets.forEach(node => {
        const parts = node.nodeValue.split(/(ã€Œ[^ã€]+ã€)/);
        const frag = document.createDocumentFragment();
        parts.forEach(part => {
          if (!part) return;
          const match = part.match(/^ã€Œ([^ã€]+)ã€$/);
          if (match) {
            const span = document.createElement('span');
            span.className = 'inline-thought';

            const sup = document.createElement('sup');
            sup.textContent = 'ğŸ’¡';
            span.appendChild(sup);

            span.appendChild(document.createTextNode('' + match[1]));
            frag.appendChild(span);
          } else {
            frag.appendChild(document.createTextNode(part));
          }
        });
        node.parentNode.replaceChild(frag, node);
      });
    }

    function buildTableOfContents() {
      const contentRoot = document.querySelector('.review-content');
      const tocRoot = document.querySelector('.review-toc');
      const shell = document.querySelector('.review-shell');
      const list = tocRoot?.querySelector('.toc-list');
      if (!contentRoot || !tocRoot || !list) return;

      const headings = Array.from(contentRoot.querySelectorAll('h1, h2, h3')).filter(
        heading => heading.textContent && heading.textContent.trim()
      );

      if (!headings.length) {
        tocRoot.classList.add('is-empty');
        shell?.classList.remove('has-toc');
        return;
      }
      shell?.classList.add('has-toc');

      const usedIds = new Set();
      const slugify = text => {
        const base = text
          .toLowerCase()
          .trim()
          .replace(/[^a-z0-9\uac00-\ud7a3\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-')
          .replace(/^-+|-+$/g, '');
        return base || 'section';
      };

      const fragment = document.createDocumentFragment();

      headings.forEach(heading => {
        const level = Math.min(parseInt(heading.tagName.replace('H', ''), 10) || 1, 3);
        const text = heading.textContent.trim();
        const baseId = heading.id || slugify(text);
        let uniqueId = baseId;
        let suffix = 2;
        while (usedIds.has(uniqueId)) {
          uniqueId = `${baseId}-${suffix}`;
          suffix += 1;
        }

        heading.id = uniqueId;
        usedIds.add(uniqueId);

        const li = document.createElement('li');
        const link = document.createElement('a');
        link.href = `#${uniqueId}`;
        link.textContent = text;
        link.className = `toc-link depth-${level}`;
        li.appendChild(link);
        fragment.appendChild(li);
      });

      list.appendChild(fragment);
    }

    function wireTocShortcuts() {
      const toTop = document.querySelector('.toc-action.toc-top');
      const toBottom = document.querySelector('.toc-action.toc-bottom');

      if (toTop) {
        toTop.addEventListener('click', () => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      }

      if (toBottom) {
        toBottom.addEventListener('click', () => {
          const target = document.querySelector('.review-footer') || document.body;
          target.scrollIntoView({ behavior: 'smooth', block: 'end' });
        });
      }
    }
  </script>
</head>

<body class="review-page">
  <main class="review-shell">
    <div class="review-container">
      <div class="review-topbar">
        <div class="review-nav-buttons">
          <a class="nav-button list-button" href="{{ '/reviews/' | relative_url }}" aria-label="ì„œí‰ ëª©ë¡ìœ¼ë¡œ">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <line x1="8" y1="6" x2="21" y2="6"></line>
              <line x1="8" y1="12" x2="21" y2="12"></line>
              <line x1="8" y1="18" x2="21" y2="18"></line>
              <line x1="3" y1="6" x2="3.01" y2="6"></line>
              <line x1="3" y1="12" x2="3.01" y2="12"></line>
              <line x1="3" y1="18" x2="3.01" y2="18"></line>
            </svg>
          </a>
          <button id="theme-toggle" class="nav-button theme-toggle" aria-label="Switch to dark mode">â˜€ï¸</button>
          <a class="nav-button home-button" href="{{ '/' | relative_url }}" aria-label="í™ˆìœ¼ë¡œ">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </a>
        </div>
      </div>

      <div class="review-header">
        <h1>{{ page.title }}</h1>
        <p class="review-meta">
          {{ page.author }}
          {%- assign pub_year = page.publication_year | default: page.publicationYear -%}
          {%- if pub_year -%}
          Â· {{ pub_year }}
          {%- endif -%}
        </p>
      </div>

      <article class="review-content markdown-body">
        {{ content }}
      </article>
      {%- assign weekday_number = page.date | date: "%w" -%}
      {%- case weekday_number -%}
      {%- when "0" -%}{% assign weekday_ko = "ì¼" %}
      {%- when "1" -%}{% assign weekday_ko = "ì›”" %}
      {%- when "2" -%}{% assign weekday_ko = "í™”" %}
      {%- when "3" -%}{% assign weekday_ko = "ìˆ˜" %}
      {%- when "4" -%}{% assign weekday_ko = "ëª©" %}
      {%- when "5" -%}{% assign weekday_ko = "ê¸ˆ" %}
      {%- when "6" -%}{% assign weekday_ko = "í† " %}
      {%- endcase -%}

      <div class="review-footer">
        <span class="review-date">
          {{ page.date | date: "%Yë…„ %-mì›” %-dì¼" }} ({{ weekday_ko }})
        </span>
      </div>
    </div>

    <nav class="review-toc" aria-label="ëª©ì°¨">
      <div class="toc-title">ëª©ì°¨</div>
      <ol class="toc-list"></ol>
      <div class="toc-actions">
        <button type="button" class="toc-action toc-top" aria-label="ë§¨ ìœ„ë¡œ">â‡¡</button>
        <button type="button" class="toc-action toc-bottom" aria-label="ë§¨ ì•„ë˜ë¡œ">â‡£</button>
      </div>
    </nav>
  </main>
</body>

</html>
